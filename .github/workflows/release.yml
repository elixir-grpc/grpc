name: Release to Hex

on:
  push:
    tags:
      - 'v*'

jobs:
  verify-and-publish:
    runs-on: ubuntu-latest
    name: Verify versions and publish to Hex
    
    steps:
      - uses: actions/checkout@v3
      
      - uses: erlef/setup-beam@v1
        with:
          otp-version: 26.1.x
          elixir-version: 1.15.x
      
      - name: Extract version from tag
        id: get_version
        run: |
          # Remove 'v' prefix from tag to get version
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Publishing version: ${VERSION}"
      
      - name: Verify versions in mix.exs files
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          
          echo "Checking grpc_core/mix.exs..."
          if ! grep -q "@version \"${VERSION}\"" grpc_core/mix.exs; then
            echo "Error: Version mismatch in grpc_core/mix.exs"
            echo "Expected: @version \"${VERSION}\""
            echo "Found:"
            grep "@version" grpc_core/mix.exs
            exit 1
          fi
          
          echo "Checking grpc_server/mix.exs..."
          if ! grep -q "@version \"${VERSION}\"" grpc_server/mix.exs; then
            echo "Error: Version mismatch in grpc_server/mix.exs"
            echo "Expected: @version \"${VERSION}\""
            echo "Found:"
            grep "@version" grpc_server/mix.exs
            exit 1
          fi
          
          echo "Checking grpc_client/mix.exs..."
          if ! grep -q "@version \"${VERSION}\"" grpc_client/mix.exs; then
            echo "Error: Version mismatch in grpc_client/mix.exs"
            echo "Expected: @version \"${VERSION}\""
            echo "Found:"
            grep "@version" grpc_client/mix.exs
            exit 1
          fi
          
          echo "âœ“ All versions match tag ${VERSION}"
      
      - name: Setup Hex credentials
        run: |
          mkdir -p ~/.hex
          echo '${{ secrets.HEX_API_KEY }}' | mix hex.config api_key --stdin
      
      - name: Publish packages to Hex
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          chmod +x scripts/publish_hex.sh
          ./scripts/publish_hex.sh ${VERSION}
      
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ steps.get_version.outputs.version }}
          body: |
            Release ${{ steps.get_version.outputs.version }}
            
            Published packages:
            - grpc_core ${{ steps.get_version.outputs.version }}
            - grpc_server ${{ steps.get_version.outputs.version }}
            - grpc_client ${{ steps.get_version.outputs.version }}
            
            See [CHANGELOG.md](https://github.com/elixir-grpc/grpc/blob/master/CHANGELOG.md) for details.
          draft: false
          prerelease: false
